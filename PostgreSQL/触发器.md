# PostgreSQL 触发器的使用

## 概述
本文介绍了 PostgreSQL 中的触发器，包括数据变更触发器（DML 触发器）和事件触发器（DDL 触发器）。触发器是一种特殊的函数，它在数据变更事件（如 INSERT、UPDATE、DELETE 或 TRUNCATE）或数据库事件（如 DDL 语句）发生时自动执行。

## 数据变更触发器
数据变更触发器分为行级触发器和语句级触发器，它们的区别在于触发的时机和次数。例如，对于一个影响多行数据的 UPDATE 语句，行级触发器会多次触发，而语句级触发器只触发一次。

### 触发器类型
- **BEFORE**：事件发生前触发
- **AFTER**：事件发生后触发
- **INSTEAD OF**：替换数据变更操作（仅适用于视图）

### 触发器函数
触发器函数与普通函数不同，它没有参数，返回类型为 `trigger`。触发器函数内部可以使用特殊的系统变量。

### 触发器定义
```sql
CREATE TRIGGER trigger_name 
{BEFORE | AFTER | INSTEAD OF} {event [OR ...]}
ON table_name
[FOR {EACH {ROW | STATEMENT}]}
[WHEN (condition)]
EXECUTE FUNCTION trigger_function;
```
其中，event 可以是 INSERT、UPDATE、DELETE 或 TRUNCATE。

示例：员工变更跟踪
```sql
CREATE TABLE employees_history (
    id serial primary key,
    employee_id int null,
    first_name varchar(20) null,
    last_name varchar(25) null,
    email varchar(25) null,
    phone_number varchar(20) null,
    hire_date date null,
    job_id varchar(10) null,
    salary numeric(8,2) null,
    commission_pct numeric(2,2) null,
    manager_id int null,
    department_id int null,
    action_type varchar(10) not null,
    change_dt timestamp not null
);

CREATE OR REPLACE FUNCTION track_employees_change()
RETURNS TRIGGER AS
$$
BEGIN
    IF tg_op = 'INSERT' THEN
        -- 插入操作
    ELSEIF tg_op = 'UPDATE' THEN
        -- 更新操作
    ELSEIF tg_op = 'DELETE' THEN
        -- 删除操作
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_employees_change
BEFORE INSERT OR UPDATE OR DELETE
ON employees
FOR EACH ROW
EXECUTE FUNCTION track_employees_change();
```

### 触发器管理
- 重命名触发器：
  ```sql
  ALTER TRIGGER name ON table_name RENAME TO new_name;
  ```
- 启用/禁用触发器：
  ```sql
  ALTER TABLE table_name {ENABLE | DISABLE} TRIGGER {trigger_name | ALL | USER};
  ```
- 删除触发器：
  ```sql
  DROP TRIGGER [IF EXISTS] trigger_name ON table_name [RESTRICT | CASCADE];
  ```

### 事件触发器
事件触发器用于捕获全局的 DDL 事件，如 ddl_command_start、ddl_command_end、table_rewrite 和 sql_drop。

示例：阻止非 postgres 用户执行 DDL 命令
```sql
CREATE OR REPLACE FUNCTION abort_any_command()
RETURNS EVENT_TRIGGER AS
$$
BEGIN
    IF (user != 'postgres') THEN
        RAISE EXCEPTION 'command % is disabled', tg_tag;
    END IF;
END;
$$ LANGUAGE plpgsql;

CREATE EVENT TRIGGER abort_ddl ON ddl_command_start
EXECUTE FUNCTION abort_any_command();
```
管理事件触发器
- 启用/禁用事件触发器：
  ```sql
  ALTER EVENT TRIGGER name DISABLE;
  ALTER EVENT TRIGGER name ENABLE;
  ```
- 重命名事件触发器：
  ```sql
  ALTER EVENT TRIGGER name RENAME TO new_name;
  ```
- 删除事件触发器：
  ```sql
  DROP EVENT TRIGGER [IF EXISTS] name [CASCADE | RESTRICT];
  ```

### 图片
